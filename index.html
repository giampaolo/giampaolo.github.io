<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <!--<title>Giampaolo Rodola</title>-->
    <title>Giampaolo Rodola</title>
    <link rel="stylesheet" href="https://gmpy.dev/theme/css/main.css" />
    <link href="https://gmpy.dev/feeds/atom.all.xml" type="application/atom+xml" rel="alternate" title="Giampaolo Rodola Atom Feed" />
    <link href="https://gmpy.dev/feeds/rss.all.xml" type="application/rss+xml" rel="alternate" title="Giampaolo Rodola RSS Feed" />
    <link rel="icon" type="image/x-icon" href="https://gmpy.dev/favicon.ico">
</head>

<body id="index" class="home">
    <header id="banner" class="body">
        <h1><a href="https://gmpy.dev/about">Giampaolo Rodola <strong>Python enthusiast, core developer, psutil author</strong></a></h1>
        <nav><ul>
            <li><a href="/">Blog</a></li>
            <li><a href="/archives">Archives</a></li>
            <li><a href="/donate">Donate</a></li>
            <li><a href="/supporters">Supporters</a></li>
            <li><a href="/about">About</a></li>
        </ul></nav>
    </header><!-- /#banner -->

<section id="content" class="body">
    <div align="center" class="newsletter-home">
        <h1 style="margin-top:0px">Newsletter</h1>
        <p>Enter your email address to receive blog updates:</p>
<form class="newsletter"
       action="https://feedburner.google.com/fb/a/mailverify"
       method="post"
       target="popupwindow"
       onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=GiampaoloRodola', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
    <input class="newsletter-text" type="text" name="email" />
        <input type="hidden" value="GiampaoloRodola" name="uri"/>
        <input type="hidden"  name="loc" value="en_US" />
    <input class="newsletter-button" type="submit" value="Subscribe" />
</form>    </div>

<!-- blog posts -->
        <ol id="posts-list" class="hfeed" start="4">
    <li><article class="hentry">
        <header>
            <h1><a href="https://gmpy.dev/blog/2020/freebsd-process-environ-and-resource-limits" rel="bookmark"
                   title="Permalink to FreeBSD process environ and resource limits">FreeBSD process environ and resource limits</a></h1>
        </header>
        <div class="entry-content">
<footer class="post-info">
        <a class="published" title="2020-10-24T00:00:00+02:00">
        Created: 24 Oct 2020,
        </a>
<!--
        <address class="vcard author">
                By                         <a class="url fn" href="https://gmpy.dev/author/giampaolo-rodola.html">Giampaolo Rodola</a>
        </address>
-->
    <a>Tags:
        <a href="https://gmpy.dev/tags/announce">announce</a>,        <a href="https://gmpy.dev/tags/python">python</a>,        <a href="https://gmpy.dev/tags/psutil">psutil</a>,        <a href="https://gmpy.dev/tags/freebsd">freebsd</a>    </a>

<!--
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="grodola">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
-->
</footer><!-- /.post-info -->            <p>New psutil 5.7.3 is out. This release adds support for 2 functionalities which
were not available on BSD platforms: the ability to get the process environment
(all BSD) and to get or set process resource limits (FreeBSD only), similarly
to what can be done on Linux.</p>
<div class="section" id="process-environ">
<h2>Process environ<a class="headerlink" href="#process-environ" title="Permalink to this headline">¶</a></h2>
<p>Quite simply:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">psutil</span><span class="o">,</span> <span class="nn">pprint</span><span class="o">,</span> <span class="nn">os</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">environ</span><span class="p">())</span>
<span class="p">{</span><span class="s1">&#39;BLOCKSIZE&#39;</span><span class="p">:</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span>
 <span class="s1">&#39;EDITOR&#39;</span><span class="p">:</span> <span class="s1">&#39;vi&#39;</span><span class="p">,</span>
 <span class="s1">&#39;GROUP&#39;</span><span class="p">:</span> <span class="s1">&#39;vagrant&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HOME&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/vagrant&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;freebsd&#39;</span><span class="p">,</span>
 <span class="s1">&#39;HOSTTYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;FreeBSD&#39;</span><span class="p">,</span>
 <span class="s1">&#39;LOGNAME&#39;</span><span class="p">:</span> <span class="s1">&#39;vagrant&#39;</span><span class="p">,</span>
 <span class="s1">&#39;MACHTYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">,</span>
 <span class="s1">&#39;MAIL&#39;</span><span class="p">:</span> <span class="s1">&#39;/var/mail/vagrant&#39;</span><span class="p">,</span>
 <span class="s1">&#39;OSTYPE&#39;</span><span class="p">:</span> <span class="s1">&#39;FreeBSD&#39;</span><span class="p">,</span>
 <span class="s1">&#39;PAGER&#39;</span><span class="p">:</span> <span class="s1">&#39;less&#39;</span><span class="p">,</span>
 <span class="s1">&#39;PATH&#39;</span><span class="p">:</span> <span class="s1">&#39;/sbin:/bin:/usr/sbin:/usr/bin:/usr/local/sbin:/usr/local/bin:/home/vagrant/bin&#39;</span><span class="p">,</span>
 <span class="s1">&#39;PWD&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/vagrant/psutil&#39;</span><span class="p">,</span>
 <span class="s1">&#39;REMOTEHOST&#39;</span><span class="p">:</span> <span class="s1">&#39;10.0.2.2&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SHELL&#39;</span><span class="p">:</span> <span class="s1">&#39;/bin/csh&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SHLVL&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SSH_CLIENT&#39;</span><span class="p">:</span> <span class="s1">&#39;10.0.2.2 58102 22&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SSH_CONNECTION&#39;</span><span class="p">:</span> <span class="s1">&#39;10.0.2.2 58102 10.0.2.15 22&#39;</span><span class="p">,</span>
 <span class="s1">&#39;SSH_TTY&#39;</span><span class="p">:</span> <span class="s1">&#39;/dev/pts/0&#39;</span><span class="p">,</span>
 <span class="s1">&#39;TERM&#39;</span><span class="p">:</span> <span class="s1">&#39;xterm-256color&#39;</span><span class="p">,</span>
 <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;vagrant&#39;</span><span class="p">,</span>
 <span class="s1">&#39;VENDOR&#39;</span><span class="p">:</span> <span class="s1">&#39;amd&#39;</span><span class="p">}</span>
</pre></div>
<p>This feature was already available on all other platforms except BSD.
It was contributed by <a class="reference external" href="https://github.com/ArminGruner">Armin Gruner</a>
in <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1800">PR-1800</a>
and supports all BSD variants (FreeBSD, NetBSD and OpenBSD).
BSD kernels expose this information via
<a class="reference external" href="https://www.freebsd.org/cgi/man.cgi?kvm_getenvv">kvm_getenvv</a>
syscall, but there are subtle differences between BSD variants which made this
integration particularly thorny. This is how it's done:</p>
<div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">psutil_proc_environ</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">pid</span><span class="p">;</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">**</span><span class="n">envs</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">[</span><span class="n">_POSIX2_LINE_MAX</span><span class="p">];</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">py_value</span><span class="o">=</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">py_retdict</span><span class="o">=</span><span class="nb">NULL</span><span class="p">;</span>
    <span class="n">kvm_t</span> <span class="o">*</span><span class="n">kd</span><span class="p">;</span>
<span class="cp">#ifdef PSUTIL_NETBSD</span>
    <span class="k">struct</span> <span class="n">kinfo_proc2</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">struct</span> <span class="n">kinfo_proc</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;l&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#if defined(PSUTIL_FREEBSD)</span>
    <span class="n">kd</span> <span class="o">=</span> <span class="n">kvm_openfiles</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;/dev/null&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="n">kd</span> <span class="o">=</span> <span class="n">kvm_openfiles</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">KVM_NO_FILES</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kd</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">convert_kvm_err</span><span class="p">(</span><span class="s">&quot;kvm_openfiles&quot;</span><span class="p">,</span> <span class="n">errbuf</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">py_retdict</span> <span class="o">=</span> <span class="n">PyDict_New</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">py_retdict</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="cp">#if defined(PSUTIL_FREEBSD)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">kvm_getprocs</span><span class="p">(</span><span class="n">kd</span><span class="p">,</span> <span class="n">KERN_PROC_PID</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">);</span>
<span class="cp">#elif defined(PSUTIL_OPENBSD)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">kvm_getprocs</span><span class="p">(</span><span class="n">kd</span><span class="p">,</span> <span class="n">KERN_PROC_PID</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">);</span>
<span class="cp">#elif defined(PSUTIL_NETBSD)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">kvm_getproc2</span><span class="p">(</span><span class="n">kd</span><span class="p">,</span> <span class="n">KERN_PROC_PID</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NoSuchProcess</span><span class="p">(</span><span class="s">&quot;kvm_getprocs&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NoSuchProcess</span><span class="p">(</span><span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">kvm_geterr</span><span class="p">(</span><span class="n">kd</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;kvm_getprocs: cnt==0&quot;</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// On *BSD kernels there are a few kernel-only system processes without an</span>
    <span class="c1">// environment (See e.g. &quot;procstat -e 0 | 1 | 2 ...&quot; on FreeBSD.)</span>
    <span class="c1">// Some system process have no stats attached at all</span>
    <span class="c1">// (they are marked with P_SYSTEM.)</span>
    <span class="c1">// On FreeBSD, it&#39;s possible that the process is swapped or paged out,</span>
    <span class="c1">// then there no access to the environ stored in the process&#39; user area.</span>
    <span class="c1">// On NetBSD, we cannot call kvm_getenvv2() for a zombie process.</span>
    <span class="c1">// To make unittest suite happy, return an empty environment.</span>
<span class="cp">#if defined(PSUTIL_FREEBSD)</span>
<span class="cp">#if (defined(__FreeBSD_version) &amp;&amp; __FreeBSD_version &gt;= 700000)</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ki_flag</span> <span class="o">&amp;</span> <span class="n">P_INMEM</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ki_flag</span> <span class="o">&amp;</span> <span class="n">P_SYSTEM</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#else</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ki_flag</span> <span class="o">&amp;</span> <span class="n">P_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
<span class="cp">#elif defined(PSUTIL_NETBSD)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">p_stat</span> <span class="o">==</span> <span class="n">SZOMB</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#elif defined(PSUTIL_OPENBSD)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">p_flag</span> <span class="o">&amp;</span> <span class="n">P_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#endif</span>
        <span class="n">kvm_close</span><span class="p">(</span><span class="n">kd</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">py_retdict</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#if defined(PSUTIL_NETBSD)</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="n">kvm_getenvv2</span><span class="p">(</span><span class="n">kd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="n">envs</span> <span class="o">=</span> <span class="n">kvm_getenvv</span><span class="p">(</span><span class="n">kd</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">envs</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Map to &quot;psutil&quot; general high-level exceptions</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">errno</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                <span class="c1">// Process has cleared it&#39;s environment, return empty one</span>
                <span class="n">kvm_close</span><span class="p">(</span><span class="n">kd</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">py_retdict</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">EPERM</span><span class="p">:</span>
                <span class="n">AccessDenied</span><span class="p">(</span><span class="s">&quot;kvm_getenvv&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">ESRCH</span><span class="p">:</span>
                <span class="n">NoSuchProcess</span><span class="p">(</span><span class="s">&quot;kvm_getenvv&quot;</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
<span class="cp">#if defined(PSUTIL_FREEBSD)</span>
            <span class="k">case</span> <span class="nl">ENOMEM</span><span class="p">:</span>
                <span class="c1">// Unfortunately, under FreeBSD kvm_getenvv() returns</span>
                <span class="c1">// failure for certain processes ( e.g. try</span>
                <span class="c1">// &quot;sudo procstat -e &lt;pid of your XOrg server&gt;&quot;.)</span>
                <span class="c1">// Map the error condition to &#39;AccessDenied&#39;.</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">errbuf</span><span class="p">,</span>
                        <span class="s">&quot;kvm_getenvv(pid=%ld, ki_uid=%d): errno=ENOMEM&quot;</span><span class="p">,</span>
                        <span class="n">pid</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ki_uid</span><span class="p">);</span>
                <span class="n">AccessDenied</span><span class="p">(</span><span class="n">errbuf</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
            <span class="k">default</span><span class="o">:</span>
                <span class="n">sprintf</span><span class="p">(</span><span class="n">errbuf</span><span class="p">,</span> <span class="s">&quot;kvm_getenvv(pid=%ld)&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
                <span class="n">PyErr_SetFromOSErrnoWithSyscall</span><span class="p">(</span><span class="n">errbuf</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">envs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="sc">&#39;=&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">py_value</span> <span class="o">=</span> <span class="n">PyUnicode_DecodeFSDefault</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">py_value</span><span class="p">)</span>
            <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">py_retdict</span><span class="p">,</span> <span class="n">envs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">py_value</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">Py_DECREF</span><span class="p">(</span><span class="n">py_value</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">kvm_close</span><span class="p">(</span><span class="n">kd</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">py_retdict</span><span class="p">;</span>

<span class="nl">error</span><span class="p">:</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">py_value</span><span class="p">);</span>
    <span class="n">Py_XDECREF</span><span class="p">(</span><span class="n">py_retdict</span><span class="p">);</span>
    <span class="n">kvm_close</span><span class="p">(</span><span class="n">kd</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="process-resource-limits">
<h2>Process resource limits<a class="headerlink" href="#process-resource-limits" title="Permalink to this headline">¶</a></h2>
<p>There's a Linux-only syscall named <a class="reference external" href="https://linux.die.net/man/2/prlimit">prlimit</a>
which lets you get or set process limits on a per-process basis.
I found out very recently that this can be emulated on FreeBSD via
<a class="reference external" href="https://www.freebsd.org/cgi/man.cgi?query=sysctl&amp;sektion=8">sysctl</a> +
<tt class="docutils literal">KERN_PROC_RLIMIT</tt>. Here's the <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1859">PR</a>
and here's the <a class="reference external" href="https://github.com/giampaolo/psutil/blob/89ae354ab7704db69a3f6c880234d21719558511/psutil/arch/freebsd/specific.c#L1082-L1164">relevant part</a>. Example on how to get/set resource
limits:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">psutil</span><span class="o">,</span> <span class="nn">os</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">rlimit</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">RLIMIT_NOFILE</span><span class="p">,</span> <span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>   <span class="c1"># process can open max 128 file descriptors</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">rlimit</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">,</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">))</span>  <span class="c1"># can create files no bigger than 1024 bytes</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">rlimit</span><span class="p">(</span><span class="n">psutil</span><span class="o">.</span><span class="n">RLIMIT_FSIZE</span><span class="p">)</span>                <span class="c1"># get</span>
<span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span>
</pre></div>
<p>Relevant C code:</p>
<div class="highlight"><pre><span></span><span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">psutil_proc_getrlimit</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">resource</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">rlp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">_Py_PARSE_PID</span> <span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CTL_KERN</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KERN_PROC</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KERN_PROC_RLIMIT</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rlp</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">sysctl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rlp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromErrno</span><span class="p">(</span><span class="n">PyExc_OSError</span><span class="p">);</span>

<span class="cp">#if defined(HAVE_LONG_LONG)</span>
    <span class="k">return</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;LL&quot;</span><span class="p">,</span>
                         <span class="p">(</span><span class="n">PY_LONG_LONG</span><span class="p">)</span> <span class="n">rlp</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">,</span>
                         <span class="p">(</span><span class="n">PY_LONG_LONG</span><span class="p">)</span> <span class="n">rlp</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="k">return</span> <span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;ll&quot;</span><span class="p">,</span>
                         <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">rlp</span><span class="p">.</span><span class="n">rlim_cur</span><span class="p">,</span>
                         <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">rlp</span><span class="p">.</span><span class="n">rlim_max</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="n">PyObject</span> <span class="o">*</span>
<span class="nf">psutil_proc_setrlimit</span><span class="p">(</span><span class="n">PyObject</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span> <span class="n">PyObject</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">resource</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="k">struct</span> <span class="n">rlimit</span> <span class="n">new</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">rlimit</span> <span class="o">*</span><span class="n">newp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">py_soft</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">PyObject</span> <span class="o">*</span><span class="n">py_hard</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">PyArg_ParseTuple</span><span class="p">(</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">_Py_PARSE_PID</span> <span class="s">&quot;iOO&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">py_soft</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">py_hard</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CTL_KERN</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">KERN_PROC</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">KERN_PROC_RLIMIT</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource</span><span class="p">;</span>

<span class="cp">#if defined(HAVE_LONG_LONG)</span>
    <span class="n">new</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">PyLong_AsLongLong</span><span class="p">(</span><span class="n">py_soft</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">==</span> <span class="p">(</span><span class="kt">rlim_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">PyErr_Occurred</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">new</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="n">PyLong_AsLongLong</span><span class="p">(</span><span class="n">py_hard</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">==</span> <span class="p">(</span><span class="kt">rlim_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">PyErr_Occurred</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="n">new</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">=</span> <span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">py_soft</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">rlim_cur</span> <span class="o">==</span> <span class="p">(</span><span class="kt">rlim_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">PyErr_Occurred</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">new</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">=</span> <span class="n">PyLong_AsLong</span><span class="p">(</span><span class="n">py_hard</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">.</span><span class="n">rlim_max</span> <span class="o">==</span> <span class="p">(</span><span class="kt">rlim_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">PyErr_Occurred</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="n">newp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">sysctl</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">newp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newp</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PyErr_SetFromErrno</span><span class="p">(</span><span class="n">PyExc_OSError</span><span class="p">);</span>
    <span class="n">Py_RETURN_NONE</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>It turns out some of this can probably also be emulated on Windows via
<a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/api/jobapi2/nf-jobapi2-setinformationjobobject?redirectedfrom=MSDN">SetInformationObject</a> and
<a class="reference external" href="https://docs.microsoft.com/en-us/windows/win32/api/jobapi2/nf-jobapi2-queryinformationjobobject">QueryInformationJobObject</a>
(see <a class="reference external" href="https://github.com/giampaolo/psutil/issues/1149">ticket</a>), so that is
something I'm looking forward to experiment with.</p>
</div>

        </div>
            <div class="blogposts-separator"></div>
    </article></li>
    <li><article class="hentry">
        <header>
            <h1><a href="https://gmpy.dev/blog/2020/new-pelican-website" rel="bookmark"
                   title="Permalink to New Pelican website">New Pelican website</a></h1>
        </header>
        <div class="entry-content">
<footer class="post-info">
        <a class="published" title="2020-06-26T00:00:00+02:00">
        Created: 26 Jun 2020,
        </a>
<!--
        <address class="vcard author">
                By                         <a class="url fn" href="https://gmpy.dev/author/giampaolo-rodola.html">Giampaolo Rodola</a>
        </address>
-->
    <a>Tags:
        <a href="https://gmpy.dev/tags/announce">announce</a>,        <a href="https://gmpy.dev/tags/python">python</a>,        <a href="https://gmpy.dev/tags/pelican">pelican</a>,        <a href="https://gmpy.dev/tags/psutil">psutil</a>    </a>

<!--
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="grodola">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
-->
</footer><!-- /.post-info -->            <p>Hello there. I present you my new blog / personal website!
This is something I've been wanting to do for a very long time, since the old blog hosted at <a class="reference external" href="https://grodola.blogspot.com/">https://grodola.blogspot.com/</a> was... well, too old. =)
This new site is based on <a class="reference external" href="https://docs.getpelican.com/en/stable/">Pelican</a>, a static website generator similar to <a class="reference external" href="https://jekyllrb.com/">Jekyll</a>. Differently from Jekyll, it uses Python instead of Ruby, and that's why I chose it. It's minimal, straight to the point and I feel I have control of things. This is what Pelican gave me out of the box:</p>
<ul class="simple">
<li>blog functionality</li>
<li>ability to write content by using reStructuredText</li>
<li>RSS &amp; Atom feed</li>
<li>easy integration with GitHub pages</li>
<li>ability to add comments via Disqus</li>
</ul>
<p>To this I added a mailing list (I used feedburner), so that users can subscribe and receive an email every time I make a new blog post. As you can see the website is very simple, but it's exactly what I wanted (minimalism). As for the domain name I opted for <a class="reference external" href="https://gmpy.dev/">gmpy.dev</a>, mostly because I know my name is hard to type and pronounce for non-english speakers. And also because I couldn't come up with a better name. ;)</p>
<div class="section" id="git-based-workflow">
<h2>GIT-based workflow<a class="headerlink" href="#git-based-workflow" title="Permalink to this headline">¶</a></h2>
<p>The main reason why I blogged so rarely over the years was mostly because blogger.com provided me no way to edit content in RsT or markdown, and the lack of GIT integration. This made me lazy. With Pelican + GitHub pages the workflow to create and publish new content is very straightforward. I use 2 branches: <a class="reference external" href="https://github.com/giampaolo/giampaolo.github.io/tree/gh-pages">gh-pages</a>, which is the source code of this web-site, and <a class="reference external" href="https://github.com/giampaolo/giampaolo.github.io/tree/master">master</a>, which is where the generated HTML content lives and it is being served by GitHub pages. This is what I do when I have to create a new blog post:</p>
<ul class="simple">
<li>under <cite>gh-pages</cite> branch I create a new file, e.g. <cite>content/blog/2020/new-blog-post.rst</cite>:</li>
</ul>
<div class="highlight"><pre><span></span><span class="gh">New blog post</span>
<span class="gh">#############</span>

<span class="nc">:date:</span> 2020-06-26
<span class="nc">:tags:</span> announce, python

Hello world!
</pre></div>
<ul class="simple">
<li>commit it:</li>
</ul>
<div class="highlight"><pre><span></span>git add content/blog/2020/new-blog-post.rst
git ci -am &quot;new blog post&quot;
git push
</pre></div>
<ul class="simple">
<li>publish it:</li>
</ul>
<div class="highlight"><pre><span></span>make github
</pre></div>
<p>Within 1 minute or something, GitHub will automatically serve <a class="reference external" href="https://gmpy.dev/">gmpy.dev</a> with the updated content. And this is why I think I will start blogging more often. =)
The core of Pelican is <a class="reference external" href="https://github.com/giampaolo/giampaolo.github.io/blob/gh-pages/pelicanconf.py">pelicanconf.py</a>, which lets you customize a lot of things by remaining independent from the theme. I still ended up modifying the default theme though, writing a customized &quot;archives&quot; view and editing CSS to make the site look better on mobile phones. All in all, I am very satisfied with Pelican, and I'm keen on recommending it to anyone who doesn't need dynamism.</p>
</div>
<div class="section" id="about-me">
<h2>About me<a class="headerlink" href="#about-me" title="Permalink to this headline">¶</a></h2>
<p>I spent most of last year (2019) in China, dating my girlfriend, remote working from a shared office space in Shenzhen, and I even taught some Python to a class of Chinese folks with no previous programming experience. The course was about the basics of the language + basic filesystem operations, and the most difficult thing to explain was indentation. I guess that shows the difference between knowing a language and knowing how to teach it.</p>
<p>I got back to Italy in December 2020, just before the pandemic occurred. Because of my connections with China, I knew about the incoming pandemic sooner than the rest of my friends, which for a while (until the lockdown) made them think I was crazy. =)</p>
<p>Since I knew I would be stuck at home for a long time, I bought a quite nice acoustic guitar (Taylor) after many years, and resumed playing (and singing). I learned a bunch of new songs, mostly about Queen, including Bohemian Rhapsody, which is something I've been wanting to do since forever.</p>
<p>I also spent some time working on a personal project that I'm keeping private for the moment, something to speed up file copies, which follows the experiments I made in <a class="reference external" href="https://bugs.python.org/issue33671">BPO-33671</a>. It's still very beta, but I managed to make file copies around 170% faster compared to <tt class="docutils literal">cp</tt> command on Linux, which is pretty impressive (and I think I can push it even further). I will blog about that once I'll have something more solid / stable. Most likely it'll become my next OSS project, even tough I have mixed feelings about that, since the amount of time I'm devoting to psutil is already a lot.</p>
<p>Speaking of which, today I'm also releasing <a class="reference external" href="https://groups.google.com/forum/#!topic/psutil/zT0jUE2IaE4">psutil 5.7.1</a>, which adds support for <strong>Windows Nano</strong>.</p>
<p>I guess this is all. Cheers and subscribe!</p>
</div>

        </div>
            <div class="blogposts-separator"></div>
    </article></li>
    <li><article class="hentry">
        <header>
            <h1><a href="https://gmpy.dev/blog/2019/system-load-average-on-windows-in-python" rel="bookmark"
                   title="Permalink to System load average on Windows in Python">System load average on Windows in Python</a></h1>
        </header>
        <div class="entry-content">
<footer class="post-info">
        <a class="published" title="2019-05-29T00:00:00+02:00">
        Created: 29 May 2019,
        </a>
<!--
        <address class="vcard author">
                By                         <a class="url fn" href="https://gmpy.dev/author/giampaolo-rodola.html">Giampaolo Rodola</a>
        </address>
-->
    <a>Tags:
        <a href="https://gmpy.dev/tags/psutil">psutil</a>,        <a href="https://gmpy.dev/tags/windows">windows</a>,        <a href="https://gmpy.dev/tags/unittest">unittest</a>,        <a href="https://gmpy.dev/tags/travel">travel</a>,        <a href="https://gmpy.dev/tags/python">python</a>    </a>

<!--
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="grodola">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
-->
</footer><!-- /.post-info -->            <p>New <a class="reference external" href="https://github.com/giampaolo/psutil/">psutil</a> 5.6.2 release implements an emulation of <a class="reference external" href="https://docs.python.org/3/library/os.html#os.getloadavg">os.getloadavg()</a> on Windows which was kindly <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1485">contributed by Ammar Askar</a> who originally implemented it for <a class="reference external" href="https://github.com/python/cpython/pull/8357/files">cPython's test suite</a>. This idea has been floating around for quite a while. The first proposal dates back to <a class="reference external" href="https://code.google.com/archive/p/psutil/issues/139">2010</a>, when psutil was still hosted on Google Code, and it popped up <a class="reference external" href="https://github.com/giampaolo/psutil/issues?utf8=%E2%9C%93&amp;q=getloadavg">multiple times</a> throughout the years. There was/is a bunch of info on internet mentioning the bits with which it's theoretically possible to do this (the so called <cite>System Processor Queue Length</cite>), but I couldn't find any real implementation. A <a class="reference external" href="https://www.google.com/search?client=ubuntu&amp;hs=2EI&amp;channel=fs&amp;ei=LafCXO2ZE8PKswX9kY-wAw&amp;q=windows+load+average&amp;oq=windows+load+average&amp;gs_l=psy-ab.3..0j0i22i30l7.12536.13873..14008...0.0..0.482.2591.4-6......0....1..gws-wiz.......0i71j0i131.37ys3SB25pE">Google search</a> tells there is quite some demand for this, but very few tools out there providing this natively (the only one I could find is this <a class="reference external" href="https://blog.sflow.com/2011/02/windows-load-average.html">sFlowTrend</a> tool and <a class="reference external" href="https://www.zabbix.com/forum/zabbix-help/50423-windows-cpu-load">Zabbix</a>), so I'm very happy this finally landed into psutil / Python.</p>
<div class="section" id="other-improvements-and-bugfixes-in-psutil-5-6-2">
<h2>Other improvements and bugfixes in psutil 5.6.2<a class="headerlink" href="#other-improvements-and-bugfixes-in-psutil-5-6-2" title="Permalink to this headline">¶</a></h2>
<p>The full list is <a class="reference external" href="https://github.com/giampaolo/psutil/blob/master/HISTORY.rst#562">here</a> but I would like to mention a couple:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/giampaolo/psutil/issues/1476">1476</a>: the possibility to set process' high I/O priority on Windows</li>
<li><a class="reference external" href="https://github.com/giampaolo/psutil/issues/1476">1458</a>: colorized test output. I admit nobody will use this directly but it's very cool and I'm porting it to a bunch of other projects I work on (e.g. pyftpdlib). Also, perhaps this could be a good candidate for a small module to put on PYPI which can also include some functionalities taken from pytest and which I'm gradually re-implementing in unittest module amongst which:<ul>
<li><a class="reference external" href="https://github.com/giampaolo/psutil/issues/1478">1478</a>: re-running failed tests</li>
<li>display test timings/durations: this is something I'm contributing to cPython, see <a class="reference external" href="https://bugs.python.org/issue4080">BPO-4080</a> and and <a class="reference external" href="https://github.com/python/cpython/pull/12271/files">PR-12271</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="about-me">
<h2>About me<a class="headerlink" href="#about-me" title="Permalink to this headline">¶</a></h2>
<p>I'm currently in China (Shenzhen) for a mix of vacation and work, and I will likely take a break from Open Source for a while (likely 2.5 months, during which I will also go to Philippines and Japan - I love Asia ;-)).</p>
</div>
<div class="section" id="external">
<h2>External<a class="headerlink" href="#external" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://www.reddit.com/r/Python/comments/bhji0m/new_psutil_562_with_load_average_emulation_on/">Reddit</a></li>
</ul>
</div>

        </div>
            <div class="blogposts-separator"></div>
    </article></li>
    <li><article class="hentry">
        <header>
            <h1><a href="https://gmpy.dev/blog/2019/psutil-560-and-process-parents" rel="bookmark"
                   title="Permalink to psutil 5.6.0 and process parents">psutil 5.6.0 and process parents</a></h1>
        </header>
        <div class="entry-content">
<footer class="post-info">
        <a class="published" title="2019-03-05T00:00:00+01:00">
        Created: 05 Mar 2019,
        </a>
<!--
        <address class="vcard author">
                By                         <a class="url fn" href="https://gmpy.dev/author/giampaolo-rodola.html">Giampaolo Rodola</a>
        </address>
-->
    <a>Tags:
        <a href="https://gmpy.dev/tags/psutil">psutil</a>,        <a href="https://gmpy.dev/tags/python">python</a>    </a>

<!--
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="grodola">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
-->
</footer><!-- /.post-info -->            <p>Hello world =)</p>
<p>It was a long time since my last blog post (over 1 year and a half). During this time I moved between Italy, Prague and Shenzhen (China), and also contributed a couple of nice patches for Python I want to blog about when Python 3.8 will be out: zero-copy for <a class="reference external" href="https://bugs.python.org/issue33671">shutil.copy()</a> functions and <a class="reference external" href="https://github.com/python/cpython/pull/11784">socket.create_server()</a> utility function. But let's move on and talk about what this blog post is about: the next major psutil version.</p>
<div class="section" id="process-parents">
<h2>Process parents()<a class="headerlink" href="#process-parents" title="Permalink to this headline">¶</a></h2>
<p>From the doc: return the parents of this process as a list of Process instances. If no parents are known return an empty list.</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">psutil</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="mi">5312</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">parents</span><span class="p">()</span>
<span class="p">[</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="mi">4699</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bash&#39;</span><span class="p">,</span> <span class="n">started</span><span class="o">=</span><span class="s1">&#39;09:06:44&#39;</span><span class="p">),</span>
 <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="mi">4689</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gnome-terminal-server&#39;</span><span class="p">,</span> <span class="n">started</span><span class="o">=</span><span class="s1">&#39;0:06:44&#39;</span><span class="p">),</span>
 <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;systemd&#39;</span><span class="p">,</span> <span class="n">started</span><span class="o">=</span><span class="s1">&#39;05:56:55&#39;</span><span class="p">)]</span>
</pre></div>
<p>Nothing really new here, as it's a convenience method based on the existing <a class="reference external" href="https://psutil.readthedocs.io/en/latest/#psutil.Process.parent">parent()</a> method, but still it's something nice to have implemented as a builtin and which can be used to work with process trees in conjunction with <a class="reference external" href="https://psutil.readthedocs.io/en/latest/#psutil.Process.children">children()</a> method. The idea was proposed by Ghislain Le Meur.</p>
</div>
<div class="section" id="windows">
<h2>Windows<a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h2>
<p>A bunch of interesting improvements occurred on Windows.</p>
<p>The first one is that certain Windows APIs requiring to be dynamically loaded from DLL libraries are now loaded only once on startup (instead of on per function call), significantly speeding up different functions and methods. This is described and implemented in PR <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1422">#1422</a> which also provides benchmarks.</p>
<p>Another one is Process' <a class="reference external" href="https://psutil.readthedocs.io/en/latest/#psutil.Process.suspend">suspend()</a> and <a class="reference external" href="https://psutil.readthedocs.io/en/latest/#psutil.Process.resume">resume()</a> methods. Before they were using <cite>CreateToolhelp32Snapshot()</cite> to iterate over all process' threads which was somewhat unorthodox and didn't work if process was suspended via Process Hacker. Now it relies on undocumented <cite>NtSuspendProcess</cite> and <cite>NtResumeProcess</cite> APIs, which is the same approach used by ProcessHacker and other famous Sysinternals tools. The change was proposed and discussed in issue <a class="reference external" href="https://github.com/giampaolo/psutil/issues/1379">#1379</a> and implemented in PR <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1435">#1435</a>. I think I will later propose the addition of suspend() and resume() method in subprocess module in Python.</p>
<p>Last nice improvement about Windows it's about <cite>SE DEBUG</cite> mode. <cite>SE DEBUG</cite> mode can be seen as a &quot;bit&quot; which you can set on the Python process on startup so that we have more chances of querying processes owned by other users, including many owned by Administrator and Local System. Practically speaking this means we will get less <cite>AccessDenied</cite> exceptions for low PID processes.  It turns out the code doing this has been broken presumably for years, and never set <cite>SE DEBUG</cite>. This is fixed now and the change was made in PR <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1429">#1429</a>.</p>
</div>
<div class="section" id="removal-of-process-memory-maps-on-osx">
<h2>Removal of Process.memory_maps() on OSX<a class="headerlink" href="#removal-of-process-memory-maps-on-osx" title="Permalink to this headline">¶</a></h2>
<p>This was somewhat <a class="reference external" href="https://github.com/giampaolo/psutil/issues/1291">controversial</a>. The history about <cite>memory_maps()</cite> on OSX is a painful one. It was based on an undocumented and probably broken Apple API called <cite>proc_regionfilename()</cite> which made <cite>memory_maps()</cite> either randomly raise <cite>EINVAL</cite> or result in segfault! Also, <cite>memory_maps()</cite> could only be used for the current process, limiting its usefulness to <cite>os.getpid()</cite> only. For any other process it raised <cite>AccessDenied</cite>. This has been a known problem for a long time but sometime over the last few years I got tired of seeing random test failures on Travis that I couldn't reproduce locally, so I commented the unit-test and forget about it until last week, when I realized the real impact this has on production code. I tried looking for a solution once again, spending quite some time looking for public source codes which managed to do this right with no luck. The only tool I'm aware of which does this right is vmmap from Apple, but it's closed source. After careful thinking, since no solution was found, I decided to just remove <cite>memory_maps()</cite> from OSX. This is not something I took lightly, but considering the alternative is getting a segfault I decided to sacrifice backward compatibility (hence the major version bump).</p>
</div>
<div class="section" id="improved-exceptions">
<h2>Improved exceptions<a class="headerlink" href="#improved-exceptions" title="Permalink to this headline">¶</a></h2>
<p>One problem which afflicted psutil maintenance over the years was receiving bug reports including tracebacks which didn't provide any information on what syscall failed exactly. This was especially painful on Windows where a single routine can invoke different Windows APIs. Now the <cite>OSError</cite> (or <cite>WindowsError</cite>) exception will include the syscall from which the error originated, see <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1428">PR-#1428</a>.</p>
</div>
<div class="section" id="other-important-bugfixes">
<h2>Other important bugfixes<a class="headerlink" href="#other-important-bugfixes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/giampaolo/psutil/issues/1353">#1353</a>: <cite>process_iter()</cite> is now thread safe</li>
<li><a class="reference external" href="https://github.com/giampaolo/psutil/issues/1411">#1411</a>: [BSD] segfault could occur on Process instantiation</li>
<li><a class="reference external" href="https://github.com/giampaolo/psutil/issues/1427">#1427</a>: [OSX] Process <cite>cmdline()</cite> and <cite>environ()</cite> may erroneously raise <cite>OSError</cite> on failed <cite>malloc()</cite>.</li>
<li><a class="reference external" href="https://github.com/giampaolo/psutil/issues/1447">#1447</a>: original exception wasn't turned into <cite>NoSuchProcess</cite> / <cite>AccessDenied</cite> exceptions when using <cite>Process.oneshot()</cite> ctx manager.</li>
</ul>
<p>A full list of enhancements and bug fixes is available <a class="reference external" href="https://github.com/giampaolo/psutil/blob/master/HISTORY.rst#560">here</a>.</p>
</div>

        </div>
            <div class="blogposts-separator"></div>
    </article></li>
    <li><article class="hentry">
        <header>
            <h1><a href="https://gmpy.dev/blog/2017/psutil-540-and-aix-support" rel="bookmark"
                   title="Permalink to psutil 5.4.0 and AIX support">psutil 5.4.0 and AIX support</a></h1>
        </header>
        <div class="entry-content">
<footer class="post-info">
        <a class="published" title="2017-10-12T00:00:00+02:00">
        Created: 12 Oct 2017,
        </a>
<!--
        <address class="vcard author">
                By                         <a class="url fn" href="https://gmpy.dev/author/giampaolo-rodola.html">Giampaolo Rodola</a>
        </address>
-->
    <a>Tags:
        <a href="https://gmpy.dev/tags/psutil">psutil</a>,        <a href="https://gmpy.dev/tags/aix">aix</a>,        <a href="https://gmpy.dev/tags/python">python</a>    </a>

<!--
<a href="https://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="grodola">Tweet</a><script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
-->
</footer><!-- /.post-info -->            <p>After a long time <a class="reference external" href="https://github.com/giampaolo/psutil/">psutil</a> finally adds support for a brand new exotic platform: AIX! Honestly I am not sure how many AIX Python users are out there (I suppose not many) but still, here it is. For this we have to thank <a class="reference external" href="https://github.com/wiggin15">Arnon Yaari</a> who started working on the porting a <a class="reference external" href="https://github.com/giampaolo/psutil/issues/605">couple of years ago</a>. To be honest I was skeptical at first because AIX is the only platform which I cannot virtualize and test on my laptop so that made me a bit nervous but Arnon did a very good job. The final <a class="reference external" href="https://github.com/giampaolo/psutil/pull/1123">PR</a> is huge, it required a considerable amount of work on his part and a review process of over 140 messages which were exchanged between me and him over the course of over 1 month during which I was travelling through China. The final result is very good, basically (almost) all original unit tests pass and the quality of the submitted code is awesome which (I must say) is kind of unusual for an external contribution like this one. Kudos to you Arnon! ;-)</p>
<p>Other than AIX support, release 5.4.0 also includes a couple of important bug fixes for <cite>sensors_temperatures()</cite> and <cite>sensors_fans()</cite> functions on Linux and the fix of a bug on OSX which could cause a segmentation fault when using <cite>Process.open_files()</cite>. Complete list of bugfixes is <a class="reference external" href="https://github.com/giampaolo/psutil/blob/master/HISTORY.rst#540">here</a>.</p>
<p>In terms of future contributions for exotic and still unsupported platforms it is worth mentioning a (still incomplete) PR for <a class="reference external" href="https://github.com/giampaolo/psutil/pull/998">Cygwin</a> which looks promising and <a class="reference external" href="https://github.com/giampaolo/psutil/pull/845">Mingw32</a> compiler support on Windows. It looks like psutil is gradually getting to a point where the addition of new functionalities is becoming more rare, so it is good that support for new platforms happens now when the API is mature and stable. Future development in this direction can also include Android and (hopefully) IOS support. Now <em>that</em> would be really awesome to have! =)</p>
<p>Stay tuned.</p>
<div class="section" id="external-links">
<h2>External links<a class="headerlink" href="#external-links" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://www.reddit.com/r/Python/comments/75wsfu/psutil_540_with_aix_support_is_out/">Reddit</a></li>
<li><a class="reference external" href="http://grodola.blogspot.com/2017/10/psutil-540-with-aix-support-is-out.html">HackerNews</a></li>
</ul>
</div>

        </div>
    </article></li>
            </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 5
        <a href="https://gmpy.dev/index2.html">&raquo;</a>
</p>
 <!-- /blog posts -->
</section>

    <!-- Footer -->
    <section id="extras" class="body">

        <div class="social">
            <h2>Social</h2>
            <ul>
                <li><a href="https://github.com/giampaolo">github</a></li>
                <li><a href="https://www.linkedin.com/in/grodola/">linkedin</a></li>
                <li><a href="https://twitter.com/grodola">twitter</a></li>
            </ul>
        </div><!-- /.social -->

        <div class="feeds">
            <h2>Feeds</h2>
            <ul>
                <li><a href="https://gmpy.dev/feeds/atom.all.xml" type="application/atom+xml" rel="alternate">atom</a></li>
                <li><a href="https://gmpy.dev/feeds/rss.all.xml" type="application/rss+xml" rel="alternate">rss</a></li>
            </ul>
        </div>
    </div>
    </section>
    <!-- /Footer -->

    <footer id="contentinfo" class="body">
        <!--
            <address id="about" class="vcard body">
            Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
            </address>

            <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        -->
    </footer>

    <script type="text/javascript">
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-164357405-2', 'auto');
    ga('send', 'pageview');
    </script>
<script type="text/javascript">
    var disqus_shortname = 'gmpy-dev';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>